<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Rotator - Buffer Fixed</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries (Latest Stable) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.7/download.min.js"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; }
        .drag-active { border-color: #4f46e5 !important; background-color: #eef2ff !important; }
        .thumb-img { transition: transform 0.2s ease-out; }
    </style>
</head>

<body class="min-h-screen flex flex-col text-slate-800">

    <!-- Navbar -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 px-6 py-3 shadow-sm flex justify-between items-center">
        <div class="flex items-center gap-2 font-bold text-xl">
            <i class="fa-solid fa-layer-group text-indigo-600"></i>
            <span>PDF<span class="text-indigo-600">Fixer</span></span>
        </div>
        <button onclick="location.reload()" class="text-sm font-medium text-slate-500 hover:text-red-600">
            Reset
        </button>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow p-6 w-full max-w-6xl mx-auto">

        <!-- Error Toast -->
        <div id="error-toast" class="hidden fixed top-20 right-5 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-lg z-[60] max-w-sm">
            <p class="font-bold">Error</p>
            <p id="error-msg" class="text-sm">Something went wrong.</p>
        </div>

        <!-- 1. Upload View -->
        <div id="view-upload" class="max-w-xl mx-auto mt-10 text-center">
            <h1 class="text-3xl font-extrabold mb-2">Rotate PDF Files</h1>
            <p class="text-slate-500 mb-8">Secure, Fast, and Error-Free.</p>
            
            <div id="drop-area" class="border-2 border-dashed border-slate-300 rounded-2xl bg-white p-12 cursor-pointer hover:border-indigo-500 transition relative">
                <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="application/pdf">
                <i class="fa-solid fa-file-arrow-up text-5xl text-indigo-100 mb-4"></i>
                <h3 class="text-lg font-bold">Click to Upload PDF</h3>
                <p class="text-xs text-slate-400 mt-1">Files are processed locally (No Upload)</p>
            </div>
        </div>

        <!-- 2. Editor View -->
        <div id="view-editor" class="hidden">
            <!-- Toolbar -->
            <div class="bg-white p-3 rounded-lg shadow border border-slate-200 sticky top-20 z-40 mb-6 flex flex-wrap justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-50 text-indigo-600 p-2 rounded"><i class="fa-solid fa-file-pdf"></i></div>
                    <div>
                        <p id="filename" class="font-bold text-sm truncate max-w-[150px]">file.pdf</p>
                        <p class="text-xs text-slate-500"><span id="page-count">0</span> Pages</p>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <button onclick="rotateAll(-90)" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded text-sm font-medium transition">
                        <i class="fa-solid fa-rotate-left"></i> Left
                    </button>
                    <button onclick="rotateAll(90)" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded text-sm font-medium transition">
                        Right <i class="fa-solid fa-rotate-right"></i>
                    </button>
                    <button onclick="savePDF()" id="btn-save" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded text-sm font-bold shadow transition flex items-center gap-2">
                        <span>Download</span> <i class="fa-solid fa-download"></i>
                    </button>
                </div>
            </div>

            <!-- Grid -->
            <div id="grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
        </div>
    </main>

    <!-- Loader -->
    <div id="loader" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center hidden">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-indigo-200 border-t-indigo-600"></div>
        <p id="loader-text" class="mt-3 font-medium text-slate-600">Processing...</p>
    </div>

    <script>
        // --- GLOBAL STATE ---
        const APP = {
            fileData: null,     // Holds the safe Uint8Array
            fileName: 'doc',
            rotations: [],
            totalPages: 0
        };

        // --- CONFIG ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // --- ELEMENTS ---
        const els = {
            drop: document.getElementById('drop-area'),
            input: document.getElementById('file-input'),
            uploadView: document.getElementById('view-upload'),
            editorView: document.getElementById('view-editor'),
            grid: document.getElementById('grid'),
            loader: document.getElementById('loader'),
            error: document.getElementById('error-toast')
        };

        // --- HANDLERS ---
        els.drop.addEventListener('dragover', (e) => { e.preventDefault(); els.drop.classList.add('drag-active'); });
        els.drop.addEventListener('dragleave', () => { els.drop.classList.remove('drag-active'); });
        els.drop.addEventListener('drop', (e) => { e.preventDefault(); els.drop.classList.remove('drag-active'); loadFile(e.dataTransfer.files[0]); });
        els.input.addEventListener('change', (e) => { loadFile(e.target.files[0]); });

        // --- 1. LOAD FILE (The Fix) ---
        function loadFile(file) {
            if (!file || file.type !== 'application/pdf') return showError("Invalid PDF file.");
            
            showLoader(true, "Reading PDF...");
            
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                try {
                    // CRITICAL FIX: Convert to Uint8Array immediately
                    const rawBuffer = e.target.result;
                    APP.fileData = new Uint8Array(rawBuffer); // Store this safely
                    APP.fileName = file.name.replace('.pdf', '');

                    // CRITICAL FIX: Pass a COPY (.slice()) to PDF.js so original stays intact
                    const pdf = await pdfjsLib.getDocument({ data: APP.fileData.slice() }).promise;
                    
                    APP.totalPages = pdf.numPages;
                    APP.rotations = new Array(APP.totalPages).fill(0);

                    // Update UI
                    document.getElementById('filename').innerText = file.name;
                    document.getElementById('page-count').innerText = APP.totalPages;

                    // Render
                    await renderGrid(pdf);

                    // Switch View
                    els.uploadView.classList.add('hidden');
                    els.editorView.classList.remove('hidden');
                    showLoader(false);

                } catch (err) {
                    console.error(err);
                    showError("Error: " + err.message);
                    showLoader(false);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // --- 2. RENDER GRID ---
        async function renderGrid(pdf) {
            els.grid.innerHTML = '';
            for (let i = 1; i <= APP.totalPages; i++) {
                try {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 0.2 });
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                    const div = document.createElement('div');
                    div.className = "flex flex-col gap-2 bg-white p-2 rounded shadow border";
                    div.innerHTML = `
                        <div class="relative bg-slate-100 flex items-center justify-center overflow-hidden cursor-pointer" style="aspect-ratio: 1/1.4" onclick="rotatePage(${i-1}, 90)">
                            <img id="thumb-${i-1}" src="${canvas.toDataURL()}" class="thumb-img max-w-full h-auto object-contain">
                            <span class="absolute top-1 left-1 bg-slate-800 text-white text-[10px] px-1.5 rounded">${i}</span>
                        </div>
                        <div class="flex justify-between">
                            <button onclick="rotatePage(${i-1}, -90)" class="p-1 text-slate-500 hover:text-indigo-600"><i class="fa-solid fa-rotate-left"></i></button>
                            <button onclick="rotatePage(${i-1}, 90)" class="p-1 text-slate-500 hover:text-indigo-600"><i class="fa-solid fa-rotate-right"></i></button>
                        </div>
                    `;
                    els.grid.appendChild(div);
                } catch(e) { console.error(e); }
            }
        }

        // --- 3. ROTATION (Visual) ---
        window.rotatePage = (idx, deg) => {
            APP.rotations[idx] = (APP.rotations[idx] + deg) % 360;
            document.getElementById(`thumb-${idx}`).style.transform = `rotate(${APP.rotations[idx]}deg)`;
        };
        window.rotateAll = (deg) => {
            for(let i=0; i<APP.totalPages; i++) rotatePage(i, deg);
        };

        // --- 4. SAVE & DOWNLOAD (Core Logic) ---
        window.savePDF = async () => {
            const btn = document.getElementById('btn-save');
            if(!APP.fileData) return showError("File data lost. Please reload.");

            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Saving...`;

            try {
                // Use the Saved Uint8Array directly
                const pdfDoc = await PDFLib.PDFDocument.load(APP.fileData);
                const pages = pdfDoc.getPages();

                pages.forEach((page, idx) => {
                    const rot = APP.rotations[idx];
                    if (rot !== 0) {
                        const current = page.getRotation().angle;
                        let final = (current + rot) % 360;
                        if (final < 0) final += 360;
                        page.setRotation(PDFLib.degrees(final));
                    }
                });

                const pdfBytes = await pdfDoc.save();
                download(pdfBytes, `${APP.fileName}-rotated.pdf`, "application/pdf");

            } catch (err) {
                console.error(err);
                showError("Save Failed: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<span>Download</span> <i class="fa-solid fa-download"></i>`;
            }
        };

        // --- UTILS ---
        function showLoader(show, text) {
            els.loader.classList.toggle('hidden', !show);
            if(text) document.getElementById('loader-text').innerText = text;
        }
        function showError(msg) {
            const toast = document.getElementById('error-toast');
            document.getElementById('error-msg').innerText = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 4000);
        }
    </script>
</body>
</html>
